---
title: "Kaggle Survey Cleaning - Project 3"
author: "Jeff Shamp"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: vignette
---

# Kaggle DS survery 2019 - Clean and Write to DB

This file is load the Kaggle Data Science Survey for 2019, cleans it, divides the questions into subsets, and writes the subsets to our project SQL server. 

```{r, include=FALSE}
library(tidyr)
library(dplyr)
library(dbplyr)
library(ggplot2)
library(RCurl)
library(RMySQL)
library(stringr)
library(ggmosaic)
```


Below is the bulk data file. We don't know to drag around all the data all the time so I'm going to split this dataframe up into subsets and clean them up for easy tidying downstream. 

```{r}
file<- "Data/multiple_choice_responses.csv"
df<-read.csv(file = file,sep = ",", stringsAsFactors = F, na.strings =T)%>% 
  mutate_if(is.character, list(~na_if(.,""))) 
row_1 <- df[1,]
df2 <- df[2:nrow(df),] %>% filter(Q5 == 'Data Scientist')
df <- rbind(row_1, df2)
```

The first table we want is the basic information; age, country, education level, company size, salary, experience level, etc. 

```{r}
df_basic<- df %>%
  select(Q1:Q2,Q3:Q4,Q6:Q8, Q10,Q11,Q15) %>%
  rename(age = Q1,         # custom name for columns
         gender = Q2, 
         country = Q3,
         education = Q4,
         company_size = Q6,
         ds_team_size = Q7,
         company_use_ml = Q8,
         compensation_USD = Q10,
         spend_ml_cloud_work_USD = Q11,
         code_exp_years = Q15) %>%
  slice(2:(dim(df)[1])) %>%
  mutate(                  # Following mutatations to clean formatting
    country = str_replace_all(country,
                "United Kingdom of Great Britain and Northern Ireland",
                "United Kingdom")) %>%
  mutate(country = str_replace_all(country, "Iran, Islamic Republic of...", "Iran")) %>%
  mutate(company_size = str_remove_all(company_size, "employees")) %>%
  mutate(education = str_remove_all(education, "degree")) %>%
  mutate(education = str_remove_all(education, "[:punct:]")) %>%
  mutate(compensation_USD = str_remove_all(compensation_USD, "[$]")) %>%
  mutate(spend_ml_cloud_work_USD = str_remove_all(spend_ml_cloud_work_USD,"[$]")) %>%
  mutate(spend_ml_cloud_work_USD = str_remove_all(spend_ml_cloud_work_USD,"\\(USD\\)")) %>%
  mutate(code_exp_years= str_remove_all(code_exp_years, "years")) %>%
  mutate(code_exp_years= str_replace_all(code_exp_years, "I have never written code", "None"))
df_basic$id <- 1:nrow(df_basic)
head(df_basic, 10)
```

A lot of columns end with a technology or choice so i'll rename the columns based the row selection choice. Also cleaning the column names to standard format. 

```{r}
rename.columns<- function(df){
items<- rep(NA, dim(df)[2])
for (i in 1:ncol(df)){
  items[i]<- str_extract(df[1,i], "[-].*")
  items[i]<- str_remove(items[i], "- Selected Choice -  |- Selected Choice -")
  items[i]<- str_remove(items[i], "\\(.*\\)")
  items[i]<- str_replace(items[i], "[:punct:]\\s", "")
  items[i]<- str_remove_all(items[i], "\\s$|^\\s")
  items[i]<- str_replace_all(items[i], "\\s", "_")
  items[i]<- str_remove(items[i], "_$")
  names(df)[names(df) == names(df[i])]<-items[i]
}
df<- df %>% slice(2:dim(df)[1])
df$id <- 1:nrow(df)
return(df)
}
```

Rip throught the subsets for cleaning.

```{r}
# Primary Tool for DA at school/work
df_prime_tool<- df %>% 
  select(Q14 )%>%
  slice(2:dim(df)[1]) %>%
  rename(primary_analysis_tool = Q14)
df_prime_tool$id <- 1:nrow(df_prime_tool)
# ML year EXP
df_ml_xp<- df %>% select(Q23) %>%
  slice(2:dim(df)[1]) %>%
  rename(ml_exp_years = Q23) %>%
  mutate(ml_exp_years = str_remove_all(ml_exp_years, "years"))
df_ml_xp$id <- 1:nrow(df_ml_xp)
# language to learn first?
df_lang_rec<- df%>% 
  select(Q19) %>%
  slice(1:dim(df)[1]) %>%
  rename(rec_lang = Q19)
df_lang_rec$id <- 1:nrow(df_lang_rec)
#media sources for DS
df_media<- df %>% select(Q12_Part_1:Q12_Part_12) %>%
  slice(2:dim(df)[1]) %>%
  rename(twiter = Q12_Part_1,
         hacker_news = Q12_Part_2,
         reddit = Q12_Part_3,
         kaggle = Q12_Part_4,
         course_forums = Q12_Part_5,
         you_tube = Q12_Part_6,
         podcast = Q12_Part_7,
         blogs = Q12_Part_8,
         journals = Q12_Part_9,
         slack_communities = Q12_Part_10,
         none = Q12_Part_11,
         other = Q12_Part_12)
df_media$id <- 1:nrow(df_media)
# DS course work including University
df_online_ed<- df %>% 
  select(Q13_Part_1:Q13_Part_12) 
df_online_ed<- rename.columns(df_online_ed) 
# IDE
df_ide <- df %>% 
  select(Q16_Part_1:Q16_Part_12) 
df_ide<-rename.columns(df_ide)
# language
df_lang<- df %>%
  select(Q18_Part_1:Q18_Part_12) 
df_lang<- rename.columns(df_lang)
# data viz
df_viz <- df %>% 
  select(Q20_Part_1:Q20_Part_12) 
df_viz<- rename.columns(df_viz) 
# ML algo used regualrly
df_ml_algo<- df %>%select(Q24_Part_1:Q24_Part_12) 
df_ml_algo<-rename.columns(df_ml_algo)
# ML Tools (e.g. AutoML)
df_ml_tool<- df %>% select(Q25_Part_1:Q25_Part_8) 
df_ml_tool<- rename.columns(df_ml_tool) 
# CV tools
df_cv<- df %>% select(Q26_Part_1:Q26_Part_7)
df_cv<-rename.columns(df_cv)
# NLP tools
df_nlp<- df %>% select(Q27_Part_1:Q27_Part_6)
df_nlp<- rename.columns(df_nlp)
# Cloud platform
df_cloud<- df %>% select(Q29_Part_1:Q29_Part_12)
df_cloud<- rename.columns(df_cloud)
# cloud products
df_cloud_prod<- df %>% select(Q30_Part_1:Q30_Part_12)
df_cloud_prod<- rename.columns(df_cloud_prod)
# big data platform
df_big_data<- df %>%select(Q31_Part_1:Q31_Part_12)
df_big_data<- rename.columns(df_big_data)
# cloud ML (e.g. Sagemaker)
df_cloud_ml<- df %>% select(Q32_Part_1:Q32_Part_12)
df_cloud_ml<- rename.columns(df_cloud_ml)
# relational DB
df_db<- df %>% select(Q34_Part_1:Q34_Part_12)
df_db<- rename.columns(df_db)
```

## Check for outliers

There are no possible numeric outliers as users did not input numbers by hand but instead chose a bin provided by the survey writers.

## Cleaning Salary data

I will clean salary data to make it numeric, allowing it to be easily plotted.

```{r}

##This function takes numeric bins and returns the mean of the bin, allowing us to more easily order/graph them.
clean_numeric_bins <- function(series){
  series <- str_remove_all(series, '[,><+/s]') %>%  str_split('-')
  series <- sapply(series, as.integer) %>% sapply(mean) %>% sapply(round)
  series
}

df_basic$compensation_USD <- clean_numeric_bins(df_basic$compensation_USD)
```

## Do age and gender affect compensation?

### Univariate Plots

First we examine the distributions of age, gender, and compensation on their own.

```{r}
df_basic %>% ggplot(aes(x = age, fill = gender)) + geom_histogram(alpha = 0.5, stat = 'count', position = 'identity')

mean(df_basic$gender == 'Male')
```

The first thing we notice is that the sample is extremely skewed, made up of almost predominantly males. In fact, almost 84% of those surveyed are male. The most common age group is 25-29, and it appears the median age is likely somewhere around 30.

```{r}
df_basic %>% ggplot(aes(factor(compensation_USD))) + geom_bar(stat = 'count') + theme(axis.text.x = element_text(angle = 90))
```

We see that the mode salary is extremely low, 500$. This is unexpected, and likely related to people filling out the survey who are not yet working as data scientists still labeling themself as a data scientist.

### Bivariate Plots

Now we will examine how age and compensation and gender and compensation vary together.

I plot these using mosaic plots, where the area of a rectangle represents the proportion of people falling into both groups.

```{r}
df_basic %>%
  ggplot() + 
  geom_mosaic(aes(x = product(age, compensation_USD), fill = age), na.rm = TRUE) + xlab('Compensation') + ylab('Age') + ggtitle('Compensation by Age Group') + theme(axis.text = element_text(size = 6), axis.text.x = element_text(angle = 90))

df_basic %>%
  ggplot() + 
  geom_mosaic(aes(x = product(gender, compensation_USD), fill = gender), na.rm = TRUE) + xlab('Compensation') + ylab('Gender') + ggtitle('Compensation by Gender') + theme(axis.text = element_text(size = 6), axis.text.x = element_text(angle = 90))

df_basic %>% ggplot(aes(x = gender, y = compensation_USD, fill = gender)) + geom_boxplot()

df_basic %>% ggplot(aes(x = age, y = compensation_USD, fill = age)) + geom_boxplot()
```

There is a clear distinction between male and female salaries, and a clear upward trend between age and salary.


## Education, Country, and Experience vs. Salary

### Univariate Plots

First we get a feeling for each variable on its own via a bar plot. I am going to apply the same approach to years of experience to make it more useable in a plot.

```{r}
##Cleaning up the education column
df_basic$education <- str_replace_all(df_basic$education, "â€™", "'") %>% str_replace_all("Some collegeuniversity study without earning a bachelor's", "Some college" ) %>% str_replace_all('No formal education past high school', 'High School')

df_basic %>% ggplot(aes(x = education)) + geom_bar(stat = 'count') + theme(axis.text.x = element_text(angle = 90))

##TODO REORDER BY COUNT, fix off tick labels
df_basic %>% ggplot(aes(x = country)) + geom_bar(stat = 'count') + theme(axis.text.x = element_text(angle = 90))

df_basic$code_exp_years <- clean_numeric_bins(df_basic$code_exp_years)
df_basic %>% ggplot(aes(x = factor(code_exp_years))) + geom_bar(stat = 'count') + theme(axis.text.x = element_text(angle = 90))
```

We see that the most common level of education is a master's degree, the most common country is the United States, although India is extremely close, and the most common level of coding experience is approximately 4 years.

### Bivariate Plots

```{r}
df_basic %>%
  ggplot() + 
  geom_mosaic(aes(x = product(education, compensation_USD), fill = education), na.rm = TRUE) + xlab('Compensation') + ylab('Education') + ggtitle('Compensation by Education') + theme(axis.text = element_text(size = 6), axis.text.x = element_text(angle = 90))

india_us <- df_basic %>% filter(country == 'United States of America'|country == 'India')

india_us %>%
  ggplot() + 
  geom_mosaic(aes(x = product(country, compensation_USD), fill = country), na.rm = TRUE) + xlab('Compensation') + ylab('Country') + ggtitle('Compensation by Country') + theme(axis.text = element_text(size = 6), axis.text.x = element_text(angle = 90))

df_basic %>%
  ggplot() + 
  geom_mosaic(aes(x = product(factor(code_exp_years), compensation_USD), fill = factor(code_exp_years)), na.rm = TRUE) + xlab('Compensation') + ylab('Coding Experience') + ggtitle('Compensation by Coding Experience') + theme(axis.text = element_text(size = 6), axis.text.x = element_text(angle = 90))
```

We find mostly what we would expect. Compensation goes up with education, is HIGHLY affected by country of origin, as US compensation greatly outpaces India's, and goes up with years of coding experience.

```{r}
df_basic %>% ggplot(aes(education, compensation_USD, fill = education)) + geom_boxplot()

india_us %>% ggplot(aes(country, compensation_USD, fill = country)) + geom_boxplot()

df_basic %>% ggplot(aes(factor(code_exp_years), compensation_USD, fill = factor(code_exp_years))) + geom_boxplot()
```

## Beyond the basic dataframe

We have lots of information broken down into many sub dataframes. I will attempt to access this information via a function rather than doing each dataframe individually.

```{r}
### Function to plot the small dataframes
plot_df <- function(df){
  mega_df <- inner_join(df_basic, df, by = 'id')
  colNames <- names(df)
  for (i in colNames){
    myplot <- mega_df %>% ggplot(aes_string(x = i, y = "compensation_USD", fill = i)) + geom_boxplot()
    print(myplot) + theme(axis.text.x = element_text(angle = 90))
  }
}
```

### Breakdown of Results